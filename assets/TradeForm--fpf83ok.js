import{u as qe,r as V,M as Oe,as as xe,a2 as Ne,au as ce,j as e,B as I,av as Re,O as g,C as X,o as q,aw as De,X as p,ax as Be,ay as z,az as Ue,aA as je,aB as k,aC as E,aD as ge,aE as Ve,aF as Xe}from"./index-TTKrRBsV.js";import{u as He,a as Ke,C as We,b as Ye}from"./CreateProductModal-C8QmnMdM.js";import{C as Ce}from"./CustomDatePicker-dCRvPDUL.js";import{C as b}from"./CustomInputNumber-BoiyYvjJ.js";import{C as Qe}from"./CustomSwitch-ir5s6zur.js";import{C as Fe}from"./CustomTextarea-DTb8tAvY.js";import{C as Y}from"./CardTitle-WCnvc5ze.js";import{T as U}from"./TitleAndIconText-Dlp7yQ8-.js";import{u as Le}from"./useClients-CTLUVbG-.js";import{u as Ze}from"./useProducts-TVEJRWTV.js";import{a as Ge}from"./trade-CwsITbu-.js";import{c as Q,a as x,o as ke,u as _e,F as o,C as u,d as fe,e as oe,f as ye,g as ve}from"./index.esm-Dv3jW_V-.js";import{C as ze}from"./CustomInput-CfXd1HaZ.js";import{u as Je}from"./useClientTypes-BFb73J4y.js";import{p as er}from"./clients-CQEBpeJ1.js";import{h as rr}from"./clients.requests-DE0ZkmW1.js";import{M as sr,R as be}from"./DeleteFilled-Lrowix85.js";import{D as L}from"./index-CwYkfvr8.js";import{R as T,C as i}from"./row-Bxwr5CQq.js";import{C as N}from"./index-Chkbatr3.js";import{R as tr}from"./PlusOutlined-Ba-GwlE8.js";const ar=()=>{const{t:f}=qe(),[Z,R]=V.useState(!1),le=()=>{R(!0)},s=()=>{R(!1)},{isLoading:C,isPending:de,mutateAsync:G}=Oe({mutationFn:rr,onSuccess:()=>{xe(),Ne(f("Muvaffaqiyatli bajarildi !"))},onError:a=>{xe(),console.log(a)}}),H=Q().shape({client_type:x().required(f("Maydonni kiritishingiz shart !")),name:x().required(f("Maydonni kiritishingiz shart !")),added:x().required(f("Maydonni kiritishingiz shart !"))}),J=ke(H),A=Je(),{control:_,formState:{errors:M},reset:D,watch:he,...h}=_e({defaultValues:{added:ce()},resolver:J}),m=()=>D({}),ee=h.handleSubmit(async a=>{try{const y=await G(er(a));(y==null?void 0:y.status)===201&&(m(),s(),window.location.reload())}catch(y){console.error("Error during form submission:",y)}});return e.jsxs(e.Fragment,{children:[e.jsx(I,{onClick:()=>le(),icon:e.jsx(Re,{size:16})}),e.jsx(sr,{title:f("Mijoz qo'shish"),open:Z,onCancel:s,footer:null,children:e.jsxs(o,{layout:"vertical",className:"create-form",name:"create-form",size:"large",onFinish:ee,children:[e.jsx(L,{}),e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:12,children:e.jsx(o.Item,{label:f("Mijoz nomi"),...g(M,"name"),required:!0,children:e.jsx(u,{name:"name",control:_,render:({field:a})=>e.jsx(ze,{...a})})})}),e.jsx(i,{xs:24,md:12,children:e.jsx(o.Item,{label:f("Telefon raqami"),...g(M,"phone"),required:!1,children:e.jsx(u,{name:"phone",control:_,render:({field:a})=>e.jsx(ze,{...a})})})}),e.jsx(i,{xs:24,md:12,children:e.jsx(o.Item,{label:f("Mijoz turi"),...g(M,"client_type"),required:!0,children:e.jsx(u,{name:"client_type",control:_,render:({field:a})=>e.jsx(X,{showSearch:!1,options:A,...a})})})}),e.jsx(i,{xs:24,md:12,children:e.jsx(o.Item,{label:f("Qo'shilgan vaqti"),...g(M,"added"),required:!0,children:e.jsx(u,{name:"added",control:_,render:({field:a})=>e.jsx(Ce,{...a})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:f("Izoh"),...g(M,"desc"),children:e.jsx(u,{name:"desc",control:_,render:({field:a})=>e.jsx(Fe,{...a})})})})]}),e.jsx(L,{}),e.jsx(o.Item,{children:e.jsxs(q,{align:"center",justify:"end",gap:"middle",children:[e.jsx(I,{htmlType:"button",onClick:s,children:f("Bekor qilish")}),e.jsx(I,{type:"primary",htmlType:"submit",loading:C,disabled:C,children:f("Yuborish")})]})})]})})]})},kr=({defaultValues:f,handleSubmit:Z,actionLoading:R=!1,readOnly:le=!1})=>{const{t:s}=qe(),{company:{currency_type:C}}=De(),de=Q().shape({client:x().required(s("Maydonni kiritishingiz shart !")),cash:x().nullable(),card:x().nullable(),other:x().nullable(),date:x().required(s("Maydonni kiritishingiz shart !")),products:fe().of(Q().shape({product:x().required(s("Maydonni kiritishingiz shart !")),price:x().required(s("Maydonni kiritishingiz shart !")),size_type:x().required(s("Maydonni kiritishingiz shart !")),count:oe().min(0,s("Miqdor noldan katta yoki teng bo'lishi kerak !")).required(s("Maydonni kiritishingiz shart !")),part_size:x().when("size_type",{is:"O'lchovli",then:()=>x().required(s("Maydonni kiritishingiz shart !"))}),height:x().when("size_type",{is:"Formatli",then:()=>x().required(s("Maydonni kiritishingiz shart !"))}),width:x().when("size_type",{is:"Formatli",then:()=>x().required(s("Maydonni kiritishingiz shart !"))})})),services:fe().of(Q().shape({service:x().required(s("Maydonni kiritishingiz shart !")),count:oe().min(0,s("Miqdor noldan katta yoki teng bo'lishi kerak !")).required(s("Maydonni kiritishingiz shart !")),price:oe().min(0,s("Narx noldan katta yoki teng bo'lishi kerak !")).required(s("Maydonni kiritishingiz shart !"))}))}).test("one-of-three-required",s("Naqt, Karta orqali yoki Boshqa maydonlaridan biri kiritilishi shart!"),function(t){const{path:r,createError:n}=this,c=parseFloat(t.cash)||0,l=parseFloat(t.card)||0,j=parseFloat(t.other)||0;return c>=0||l>=0||j>=0?!0:n({path:`${r}.cash`,message:s("Naqt, Karta orqali yoki Boshqa maydonlaridan biri kiritilishi shart!")})}).test("total-less-than-summa",s("To'lovlarning umumiy summasi qarzdorlikdan oshmasligi kerak!"),function(t){const{path:r,createError:n}=this,c=parseFloat(t.cash)||0,l=parseFloat(t.card)||0,j=parseFloat(t.other)||0;return c+l+j<=ae?!0:n({path:`${r}.total_summa`,message:s("To'lovlarning umumiy summasi qarzdorlikdan oshmasligi kerak!")})}).test("product-count",s("Mahsulotning tanlangan miqdori mavjud miqdordan oshib ketishi mumkin emas!"),function(t){const{path:r,createError:n}=this,c=t.products||[];for(let l=0;l<c.length;l++){const j=c[l],B=j.product,S=parseFloat(j.count)||0,ie=parseFloat(j.part_size)||1,O=parseFloat(j.width)||1,d=parseFloat(j.height)||1,$=S*ie*O*d,v=D.find(Pe=>Pe.id==B),ne=parseFloat(v?v.current_total_count:0);if(v&&v.product_type==="Sanaladigan"&&$>ne)return n({path:`${r}.products[${l}].total_count`,message:s("Omborda mahsulot yetarli emas!")})}return!0}),G=ke(de),{servicesOptions:H,servicesData:J}=He(),{clientsOptions:A,clientsData:_}=Le(),{productsOptions:M,productsData:D}=Ze(),he=Ke(),{control:h,formState:{errors:m},reset:ee,watch:a,setValue:y,getValues:F,...Me}=_e({defaultValues:{date:ce(),client:"",products:[{size_type:"O'lchovsiz"}],services:[],pay_type:!0,discount_summa:0,...f},resolver:G});V.useEffect(()=>{if(A&&A.length>0){const t=_.find(r=>p.get(r,"client_type")==="Tezkor");t&&y("client",p.get(t,"id",""))}},[A,y]);const{fields:ue,append:Se,remove:Te}=ye({control:h,name:"products"}),{fields:me,append:Ie,remove:re}=ye({control:h,name:"services"}),pe=()=>{const t=_.find(r=>p.get(r,"client_type")==="Tezkor");ee({date:ce(),client:p.get(t,"id",""),products:[{size_type:"O'lchovsiz"}],services:[],pay_type:!0,discount_summa:0})},we=Me.handleSubmit(t=>{Z(Ge(t),pe)}),$e=t=>{const r=a("services")||[];if(t.length===0){r.slice().reverse().forEach((c,l)=>re(r.length-1-l));return}const n=t.map(c=>c[0]);t.forEach(c=>{var l;r.some(j=>j.service===c[0])||Ie({service:c[0],count:1,price:(l=J.find(j=>j.id===c[0]))==null?void 0:l.price})}),r.forEach((c,l)=>{n.includes(c.service)||re(l)})},Ee=t=>{var c;const n=(a("services")||[])[t].service;re(t),y("service_types",(c=a("service_types"))==null?void 0:c.filter(l=>l[0]!==n))},se=ve({control:h,name:"services"}),te=ve({control:h,name:"products"}),K=Math.round(se==null?void 0:se.reduce((t,r)=>{const n=parseFloat(p.get(r,"price",0)),c=parseFloat(p.get(r,"count",0)),l=n*c;return t+parseFloat(l.toFixed(2))},0)),W=Math.round(te==null?void 0:te.reduce((t,r)=>{const n=parseFloat(p.get(r,"price",0)),c=parseFloat(p.get(r,"count",0)),l=parseFloat(p.get(r,"part_size",1)),j=parseFloat(p.get(r,"width",1)),B=parseFloat(p.get(r,"height",1));let S=n*c*l*j*B;return S%1!==0&&(S=parseFloat(S.toFixed(2))),t+S},0)),ae=Math.round((K||0)+(W||0)),w=ae-parseFloat(a("discount_summa"))||0,P=a("pay_type");V.useEffect(()=>{if(P){const t=F("card")||0,r=F("other")||0,n=w-t-r;n!==F("cash")&&y("cash",n>=0?n:0)}},[w,a("card"),a("other"),P]),V.useEffect(()=>{if(P){const t=F("cash")||0,r=F("other")||0,n=w-t-r;n!==F("card")&&y("card",n>=0?n:0)}},[w,a("cash"),a("other"),P]),V.useEffect(()=>{if(P){const t=F("cash")||0,r=F("card")||0,n=w-t-r;n!==F("other")&&y("other",n>=0?n:0)}},[w,a("cash"),a("card"),P]);const Ae=a(["cash","card","other"]).reduce((t,r)=>t+(parseFloat(r)||0),0);return e.jsxs(o,{layout:"vertical",className:"create-form",name:"create-form",size:"large",onFinish:we,children:[e.jsx(L,{}),e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:18,children:e.jsxs(q,{gap:"large",vertical:!0,children:[e.jsx(N,{title:e.jsx(Y,{title:s("Mijoz va xizmatlar")}),children:e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Mijoz"),...g(m,"client"),required:!0,children:e.jsx(u,{name:"client",control:h,render:({field:t})=>e.jsxs(Be.Compact,{style:{width:"100%"},children:[e.jsx(X,{options:A,addonAfter:"AAA",...t,style:{width:"100%"}}),e.jsx(ar,{})]})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Xizmatlar"),...g(m,"service_types"),required:!1,children:e.jsx(u,{name:"service_types",control:h,render:({field:t})=>e.jsx(We,{...t,options:H,onChange:r=>{t.onChange(r),$e(r)},multiple:!0})})})})]})}),!p.isEmpty(me)&&e.jsx(N,{title:e.jsx(Y,{title:s("Qo'shimcha xizmatlar")}),children:e.jsxs(q,{gap:"large",vertical:!0,children:[me.map((t,r)=>e.jsx(e.Fragment,{children:e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:22,children:e.jsx(N,{hoverable:!0,children:e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Xizmat"),...z(m,"services",r,"service"),required:!0,children:e.jsx(u,{name:`services.${r}.service`,control:h,render:({field:n})=>e.jsx(X,{...n,disabled:!0,options:H})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Miqdori"),...z(m,"services",r,"count"),required:!0,children:e.jsx(u,{name:`services.${r}.count`,control:h,render:({field:n})=>e.jsx(b,{...n})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Narxi"),...z(m,"services",r,"price"),required:!0,children:e.jsx(u,{name:`services.${r}.price`,control:h,render:({field:n})=>e.jsx(b,{addonAfter:C,...n})})})})]},t.id)})}),e.jsx(i,{xs:24,md:2,children:e.jsx(I,{icon:e.jsx(be,{}),danger:!0,size:"small",onClick:()=>Ee(r)})})]})})),e.jsxs(q,{gap:"small",align:"center",children:[e.jsx(Ue,{size:20}),e.jsxs(je.Text,{type:"warning",strong:!0,children:[s("SUMMA"),": ",k(K)]})]})]})}),e.jsx(N,{title:e.jsxs(q,{horizontal:!0,align:"center",justify:"space-between",children:[e.jsx(Y,{title:s("Mahsulotlar")}),e.jsxs(q,{align:"center",justify:"space-between",gap:"20px",children:[e.jsx(Ye,{}),e.jsx(I,{icon:e.jsx(tr,{}),type:"primary",size:"small",onClick:()=>Se({size_type:"O'lchovsiz"}),children:s("MAHSULOT")})]})]}),children:e.jsxs(q,{gap:"large",vertical:!0,children:[ue.map((t,r)=>{const n=a("products").map(d=>d.product),c=a(`products.${r}.product`);M.filter(d=>!n.includes(d.value)||d.value===c);const l=D.find(d=>d.id===c),j=parseFloat(p.get(a(`products.${r}`),"count",0)),B=parseFloat(p.get(a(`products.${r}`),"part_size",1)),S=parseFloat(p.get(a(`products.${r}`),"width",1)),ie=parseFloat(p.get(a(`products.${r}`),"height",1));let O=j*B*S*ie;return O%1!==0&&(O=parseFloat(O.toFixed(2))),e.jsx(e.Fragment,{children:e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:22,children:e.jsx(N,{hoverable:!0,children:e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Mahsulot"),...z(m,"products",r,"product"),required:!0,children:e.jsx(u,{name:`products.${r}.product`,control:h,render:({field:d})=>e.jsx(X,{...d,options:M,onChange:$=>{d.onChange($);const v=D.find(ne=>ne.id===$);v&&y(`products.${r}.price`,v.price)}})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Narxi"),...z(m,"products",r,"price"),required:!0,children:e.jsx(u,{name:`products.${r}.price`,control:h,render:({field:d})=>e.jsx(b,{addonAfter:C,...d})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("O'lcham turi"),...z(m,"products",r,"size_type"),required:!0,children:e.jsx(u,{name:`products.${r}.size_type`,control:h,render:({field:d})=>e.jsx(X,{options:he,showSearch:!1,...d})})})}),a(`products.${r}.size_type`)==="O'lchovli"&&e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("O'lchami"),...z(m,"products",r,"part_size"),required:!0,children:e.jsx(u,{name:`products.${r}.part_size`,control:h,render:({field:d})=>e.jsx(b,{min:0,...d})})})}),a(`products.${r}.size_type`)==="Formatli"&&e.jsxs(e.Fragment,{children:[e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Bo'yi"),...z(m,"products",r,"height"),required:!0,children:e.jsx(u,{name:`products.${r}.height`,control:h,render:({field:d})=>e.jsx(b,{min:0,...d})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Eni"),...z(m,"products",r,"width"),required:!0,children:e.jsx(u,{name:`products.${r}.width`,control:h,render:({field:d})=>e.jsx(b,{min:0,...d})})})}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Perimetr"),children:(()=>{const d=a(`products.${r}.height`),$=a(`products.${r}.width`);let v=0;return d&&$&&(v=2*(parseFloat(d)+parseFloat($)),v%1!==0&&(v=v.toFixed(2))),e.jsx("div",{children:v})})()})})]}),e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Miqdori"),...z(m,"products",r,"count"),required:!0,children:e.jsx(u,{name:`products.${r}.count`,control:h,render:({field:d})=>e.jsx(b,{min:0,...d})})})}),c&&e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Ombordagi joriy miqdori"),children:p.get(l,"product_type","Sanaladigan")=="Sanaladigan"?e.jsx(e.Fragment,{children:k(p.get(l,"current_total_count",""),p.get(l,"format.name",""))}):s("Sanalmaydigan mahsulot")})}),c&&e.jsx(i,{xs:24,md:6,children:e.jsx(o.Item,{label:s("Tanlangan miqdor"),...z(m,"products",r,"total_count"),children:k(O,p.get(l,"format.name",""))})})]},t.id)})}),e.jsx(i,{xs:24,md:2,children:ue.length>1&&e.jsx(I,{icon:e.jsx(be,{}),danger:!0,size:"small",onClick:()=>Te(r)})})]})})}),e.jsxs(q,{gap:"small",align:"center",children:[e.jsx(E,{size:20}),e.jsxs(je.Text,{type:"default",strong:!0,children:[s("SUMMA"),": ",k(W)]})]})]})})]})}),e.jsx(i,{xs:24,md:6,children:e.jsx(N,{title:e.jsx(Y,{title:s("To'lov")}),children:e.jsxs(T,{gutter:[20,20],children:[e.jsx(i,{xs:24,md:24,children:e.jsxs(q,{vertical:!0,gap:"middle",children:[e.jsx(U,{title:s("Mahsulotlar").toUpperCase(),value:k(W),icon:e.jsx(E,{})}),e.jsx(U,{type:"warning",title:s("Xizmatlar").toUpperCase(),value:k(K),icon:e.jsx(E,{})}),e.jsx(U,{type:"success",title:s("Umumiy summa").toUpperCase(),value:k(ae),icon:e.jsx(E,{})})]})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Chegirma"),...g(m,"discount_summa"),required:!0,children:e.jsx(u,{name:"discount_summa",control:h,render:({field:t})=>e.jsx(b,{addonAfter:C,prefix:e.jsx(E,{}),...t})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(q,{vertical:!0,gap:"middle",children:e.jsx(U,{title:s("To'lov summasi").toUpperCase(),value:k(w),icon:e.jsx(E,{})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Barchasini to'lash"),...g(m,"pay_type"),required:!0,children:e.jsx(u,{name:"pay_type",control:h,render:({field:t})=>e.jsx(Qe,{prefix:e.jsx(ge,{}),...t})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Naqt"),...g(m,"cash"),required:!0,children:e.jsx(u,{name:"cash",control:h,render:({field:t})=>e.jsx(b,{addonAfter:C,prefix:e.jsx(ge,{}),...t})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Karta orqali"),...g(m,"card"),required:!0,children:e.jsx(u,{name:"card",control:h,render:({field:t})=>e.jsx(b,{addonAfter:C,prefix:e.jsx(Ve,{}),...t})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Boshqa"),...g(m,"other"),required:!0,children:e.jsx(u,{name:"other",control:h,render:({field:t})=>e.jsx(b,{addonAfter:C,prefix:e.jsx(Xe,{}),...t})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{...g(m,"total_summa"),children:e.jsx(U,{type:"success",title:s("Summa").toUpperCase(),value:k(Ae),icon:e.jsx(E,{})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Sana"),...g(m,"date"),required:!0,children:e.jsx(u,{name:"date",control:h,render:({field:t})=>e.jsx(Ce,{...t})})})}),e.jsx(i,{xs:24,md:24,children:e.jsx(o.Item,{label:s("Izoh"),...g(m,"desc"),children:e.jsx(u,{name:"desc",control:h,render:({field:t})=>e.jsx(Fe,{...t})})})})]})})})]}),e.jsx(L,{}),e.jsx(o.Item,{children:e.jsxs(q,{align:"center",justify:"end",gap:"middle",children:[e.jsx(I,{htmlType:"button",onClick:pe,children:s("Tozalash")}),e.jsx(I,{type:"primary",htmlType:"submit",loading:R,disabled:R,children:s("Yuborish")})]})})]})};export{kr as T};
